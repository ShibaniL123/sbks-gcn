Distinguishing Closed and Open Respiratory Airway Apneas by Complex Admittance Values Related Application: [0001] This application claims priority of US Provisional Application 60/823,973, filed August 30, 2006, and US Provisional Application 60/916,147, filed May 4, 2007, the specifications and drawings of which are incorporated herein by reference. Field of the Invention [0002] This invention relates to the discrimination of open and closed apneas (i.e. the complete cessation of breathing). In an open apnea the airway is patent, while in a closed apnea there is a total obstruction of the airway. The discrimination between such apneas is advantageous in the diagnosis and treatment of respiratory conditions that have adverse effects on a person's wellbeing. Background of the Invention [0003] The expression "airway" as used herein is to be understood as the anatomical portion of the respiratory system between the nares and the bronchi, including the trachea. The expression "respiration" is to be understood as the continually repeating events of inspiration (inhaling) followed by expiration (exhaling). [0004] In the Sleep Apnea syndrome a person stops breathing during sleep. Cessation of airflow for more than 10 seconds is called an "apnea". Apneas lead to decreased blood oxygenation and thus to disruption of sleep. Apneas are traditionally categorized as either central, where there is no respiratory effort, or obstructive, where there is respiratory effort. With some central apneas, the airway is patent, and the subject is merely not attempting to breathe. Conversely, with other central apneas and all obstructive apneas, the airway is not patent (i.e. occluded). The occlusion is usually at the level of the tongue or soft palate. The airway may also be partially obstructed (i.e. narrowed or partially patent). This also leads to decreased ventilation (hypopnea), decreased blood oxygenation and disturbed sleep. [0005] The dangers of obstructed breathing during sleep are well known in relation to the Obstructive Sleep Apnea (OSA) syndrome. Apnea, hypopnea and heavy snoring are recognized as causes of sleep disruption and risk factors in certain types of heart disease. Increased upper airway resistance (Upper Airway Resistance syndrome) during sleep without snoring or sleep apnea also can cause sleep fragmentation and daytime sleepiness. [0006] The common form of treatment of these syndromes is the administering of Continuous Positive Airway Pressure (CPAP). Briefly stated, CPAP treatment acts as a pneumatic splint of the airway by the provision of a positive pressure, usually in the range 4-20 cm H20. The air is supplied to the airway by a motor driven blower or other flow generator (FG) whose outlet passes via an air delivery hose to a nose (or nose and/or mouth) mask sealingly engaged to a patient's face. An exhaust port is provided in the delivery tube proximate to the mask. More sophisticated forms of CPAP, such as bi-level CPAP and autosetting CPAP, are described in U.S. Pat. Nos. 5,148,802 and 5,245,995 respectively. [0007] As noted, central apneas need not involve an obstruction of the airway, and often occur during very light sleep and also in patients with various cardiac, cerebrovascular and endocrine conditions unrelated to the state of the upper airway. In those cases where the apnea occurs without obstruction of the airway, there is little benefit in treating the condition by techniques such as CPAP. In automated CPAP systems, it is important to accurately distinguish apneas with an open airway from apneas with a closed airway, in order to avoid inappropriately increasing the CPAP splinting air pressure. Such unnecessary increases in pressure reflexly inhibit breathing, further aggravating the breathing disorder. [0008] U.S. Pat. No. 5,245,995 describes how snoring and abnormal breathing patterns can be detected by inspiration and expiration pressure measurements while sleeping, thereby leading to early indication of preobstructive episodes or other forms of breathing disorder. Particularly, patterns of respiratory parameters are monitored, and CPAP pressure is raised on the detection of predefined patterns to provide increased airway pressure to, ideally, prevent the occurrence of the obstructive episodes and the other forms of breathing disorder. Prior Use of the Forced Oscillation Technique [0009] U.S. Pat. No. 5,704,345, entitled “Detection Of Apnea And Obstruction Of The Airway In The Respiratory System” describes various techniques for sensing and detecting abnormal breathing patterns indicative of obstructed breathing, including the determination of airway patency by a forced oscillation technique (FOT) in which an oscillatory pressure waveform of known frequency is applied to a patient’s airway and the magnitude of the component of an airflow signal at the known frequency induced by the oscillatory pressure waveform is calculated and compared with a threshold value. The present invention is an improvement of the methods and apparatus disclosed in the ‘345 patent. [0010] The use of pressure oscillations at frequencies of the order of 4 Hz to determine airway patency was used in the ResMed AutoSet Clinical automatic CPAP device and the PI I Plus. In these machines which used FOT, the pressure was measured at the mask, and the flow was measured very close to the mask, on the patient side of the mask vent. The present invention finds an advantage in measuring pressure and flow at or near the flow generatory at least for analyzing the effect of the forced oscillation technique. [0011] The prior art implementations of FOT are less accurate in distinguishing between closed and open apneas when there is present moderate leak and moderate “resistance” in the airpath between the flow generator and the patient. For example, a passive patient simulation consisting of a 3-4 cm H20/(l/s) resistance, with an adjustable leak, would indicate an open airway at a leak of 15 l/min and a closed airway at a leak of 20 l/min. What is needed is a system that more accurately distinguishes between open and closed apneas. In particular what is needed is a system that goes beyond treating the components of the airpath simply as nonlinear resistances and which utilizes an algorithm that takes into account the capacitive and inductive components of the airpath impedance. Brief Description of the Invention [0012] In a prior filed US Provisional Patent Application, Serial No. 60/823,973, filed August 30, 2006, it was disclosed that an effective method for discriminating between closed and open respiratory airway apneas was by determining the complex admittance of a patient airway and comparing the absolute value of the complex admittance to threshold values. That disclosure employed an algorithm that takes into account the patient circuit and models each component (patient circuit, vent flow and leak) in order to determine the patient pressure and flow. In particular, the small-signal hose pressure drop was modeled as a two port network in which the parameters were a function of mean flow. The present invention includes embodiments that are an improvement on that technique by including more information from that complex quantity, namely the phase angle of the admittance, or both the real and imaginary components of the complex quantity, in discriminating between open and closed apneas. In particular, it has been surprisingly discovered by analyzing data previously identified with open and closed apneas, that there is significantly better separation of the data if the phase angle of the admittance is taken into account. In addition, the previous system is simplified by modeling the pressure drop without having to measure the AC impedance of the patient circuit across a range of flows. [0013] A plot of the magnitude of admittance against the phase of admittance provides distinct areas of the plot that indicate open or closed airways. Alternatively, the real part of the admittance may be plotted against the imaginary part in an Argand diagram, resulting again in distinct areas of the diagram being associated with open and closed apneas. [0014] The invention provides an improved method and apparatus for treating a patient subject to apneas. In particular it relies upon improved methods for determining whether an apnea is closed or open, by identifying sets of values of the complex patient admittance that are respectively characteristic of open or closed apneas. The admittance is the reciprocal of the complex impedance of the apparatus parameterized for example as a two port model of flow impedance or determining resistive and inertial components from a theoretical model employing empirically derived resistive constants and theoretically determined flow inertance constants. [0015] A sinusoidal (e.g. 4 Hz) pressure oscillation is applied at the input to the airpath, while flow and pressure is measured both at the input and output of the airpath. Based upon the two port model or the more theoretical hose drop model, the admittance is determined from the AC component of the patient airflow (found by subtracting the AC components of vent flow and leak) and the AC component of the mask pressure. The vent flow, in turn, is determined from an improved quadratic relationship to mask pressure in the case of the two port model, or a linearized calculation in the more theoretical hose drop model. The leak is determined from an estimated leak coefficient. The calculation of AC components of these quantities is improved over prior estimations by using Fourier sine and cosine components at the input oscillation frequency rather than by approximating an orthonormal set of functions by square waves. [0016] The invention discloses a method for determining patency of the airway of a patient, the method comprising the steps of: applying an oscillatory pressure waveform of known frequency to the patient's airway; measuring respiratory air flow and pressure at the flow generator; calculating the AC values of flow and pressure at the mask from a 2-port impedance model, determining that the airway is patent by determining whether the complex admittance is in a region characteristic of patency. [0017] Advantageously the admittance is determined from the ratio of AC values of patient flow and mask pressure, and there is the step of comparing the value of the complex admittance with ranges of values for which the airway is declared patent. [0018] The invention yet further discloses a method for determining the degree of patency of the airway of a patient, the method comprising the steps of: applying an oscillatory pressure waveform of known frequency, magnitude and phase at an entrance to the patient's airway; measuring respiratory air flow from the patient; determining the magnitude and phase of the component of said air flow at said known frequency induced by said oscillatory pressure waveform; and determining the degree of patency as the location of the complex admittance within the region indicative of patency. [0019] To minimize the effect of the delivery system not supplying a predetermined waveform in the aforementioned method, the pressure waveform actually produced is measured. In this technique we initially apply a waveform of some amplitude at the flow generator, calculate or observe the magnitude of the pressure waveform at the mask, then adjust (typically increasing) the amplitude at the flow generator in order to produce a desired amplitude at the mask. Given that the system is approximately linear for these small signals, the calculation as to how much to increase the driving waveform is a calculation of the radio of the desired to the actual pressure magnitude at the mask. The advantage of this approach is an improvement in the signal to noise ratio. [0020] The invention yet further discloses a method for controlling the administration of CPAP treatment to the airway of a patient by means controllable to supply breathable air to the patient's airway continually at a selectable pressure elevated above atmospheric pressure, the method comprising the step of: commencing or increasing CPAP treatment pressure if an apnea is occurring, determined by the steps of: measuring respiratory air flow from the patient as a function of time; and determining the deviation of said admittance from the centroid of the region of patency. [0021] The invention yet further discloses apparatus for determining patency of the airway of a patient, the apparatus comprising: means for applying an oscillatory pressure waveform of known frequency to the patient's airway; means for measuring respiratory air flow from the patient; and means for determining that the airway is patent if there is an admittance within a patency region at said known frequency induced by said oscillatory pressure waveform. [0022] The invention yet further discloses apparatus for determining the degree of patency of the airway of a patient, the apparatus comprising: means for applying an oscillatory pressure waveform of known frequency and magnitude to the patient's airway; means for determining the complex admittance of respiratory air flow from the patient; and means for determining the degree of patency as the deviation of said induced admittance from the centroid of a patency region. [0023]The invention yet further discloses a method of distinguishing between open and closed airway apneas of a patient comprising the steps of: (i) connecting a respiratory device to a patient via an air delivery tube and a patient interface; (ii) delivering an alternating pressure waveform to the patient from the respiratory device to the patient via the air delivery tube; (iii) measuring a flow rate and pressure of air at the respiratory device; (iv) determining a capacitive component of an air delivery tube impedance; (ν) determining a patient admittance from said measured flow and pressure of air and said capacitive component; (vi) distinguishing between an open and closed airway apnea on the basis of said patient admittance. [0024]The invention yet further discloses method of distinguishing between open and closed airway apneas of a patient comprising the steps of: (i) connecting a respiratory device to a patient via an air delivery tube and a patient interface; (ii) delivering an alternating pressure waveform to the patient from the respiratory device to the patient via the air delivery tube; (iii) measuring a flow rate and pressure of air at the respiratory device; (iv) determining an inductive component of an air delivery tube impedance; (ν) determining a patient admittance from said measured flow and pressure of air and said capacitive component; (vi) distinguishing between an open and closed airway apnea on the basis of said patient admittance. [0025] In another form of the invention patency of the airway is determined to be unknown, or in a "don't know" region. Another aspect of the invention is that patency is defined as having a gradual scale from open to closed. Another aspect is that apnea discrimination regions are defined in the complex plane, the regions not necessarily being contiguous. A further refinement is that the discrimination regions may be functions of the average leak level; in particular, the don’t-know regions probably increase in size with increasing leak. [0026]The invention yet further discloses an apparatus for providing a supply of continuous positive airway pressure to an airway of a patient at a desired treatment pressure, the apparatus comprising: a flow generator adapted to provide a supply of continuous positive airway pressure, the flow generator adapted to couple with an air delivery tube coupled with a patient interface configured to sealingly engaged with a face of the patient; a means for determining respiratory air flow and pressure in the patient interface; a means for measuring a patient impedance of the airway during a period of a breathing cycle when an apnea is not occurring; and a controller to control operation of the flow generator based on the determined respiratory air flow and pressure, the controller configured in use to detect the occurrence of an apnea and to determine patency of the patient’s airway during the apnea by performing: controlling application of an oscillatory pressure waveform of known frequency to the patient interface for delivery to the patient’s airway in use; measuring an apnea impedance of the airway during the apnea; and comparing the measured apnea impedance with the patient impedance to determine whether the airway is patent. [0027]The invention yet further discloses method for operating a respiratory device with a flow generator to determine patency of an airway of a patient, the method comprising: controlling generation of a first oscillatory pressure waveform of known frequency to a patient interface during a period of a breathing cycle when an apnea is not occurring; measuring respiratory air flow and pressure at the flow generator; determining a patient impedance of the airway; determining that an apnea is occurring based on the measured respiratory air flow; controlling generation of a second oscillatory pressure waveform of known frequency to the patient interface during the apnea; determining an apnea impedance of the airway during the apnea; and determining that the airway is patent by comparing the apnea impedance with the patient impedance. [0028] Further forms of the invention are as set out in the claims. Brief Description of the Drawings [0029] Embodiments of the invention will now be described with reference to the accompanying drawings, in which: [0030] FIG. 1 shows a flow diagram of the basic methodology of an embodiment; [0031] FIG. 2 shows, in diagrammatic form, apparatus embodying the invention; [0032] FIG. 3 shows an electronic analogue of the 2-port analysis of the present invention. [0033] FIG. 4 shows values of the complex admittance based on a detailed algorithm. [0034] FIG. 5 shows values of the complex admittance based on a simplified algorithm. Detailed Description of Preferred Embodiments and Best Mode A System Implementing The Invention [0035] The present invention is an improvement upon the embodiments disclosed in US patent 5,704,345, which is incorporated by reference in its entirety. FIG. 1 is a flow diagram of the basic methodology of one embodiment of the present invention. The first step 10 of the present invention is the measurement of respiratory flow and pressure at points near the flow generator over time where an apnea is occurring. This information is processed in step 12 to generate admittance values to be used as qualitative measures for subsequent processing. Steps 14-16 detect whether a closed, open or mixed apnea is occurring by comparison of the complex admittance value in a time window with a patency region. [0036] If an apnea is in progress there then follows a determination whether the apnea is open or closed. If an apnea with an open airway is occurring, and, if desired, the event is logged in step 18. If the result of step 16 is that an apnea with a closed airway is occurring, an increase in CPAP treatment pressure occurs in step 20. If desired, step 20 may include the optional logging of the detected abnormality. [0037] In the instance of an apnea with an open airway the CPAP treatment pressure is reduced, in accordance with usual methodologies that seek to set the minimal pressure required to obviate, or at least reduce, the occurrence of apneas. The amount of reduction in step 22 may, if desired, be zero. [0038] The methodology represented in FIG. 1 is of a clinical embodiment, where patient CPAP pressure is controlled over time as appropriate. A purely diagnostic embodiment operates in the same manner except it omits the CPAP pressure increase and pressure decrease actions of step 20 and step 22 respectively. [0039] FIG. 2 shows, in diagrammatic form, clinical CPAP apparatus in accordance with one embodiment for implementing the methodology of FIG. 1. A mask 30, whether either a nose mask and/or a face mask, is sealingly fitted to a patient's face. Fresh air, or oxygen enriched air, enters the mask 30 by flexible tubing 32 which, in turn, is connected with a motor driven turbine (flow generator) 34 to which there is provided an air inlet 36. The motor 38 for the turbine is controlled by a motor-servo unit 40 to either increase or decrease the pressure of air supplied to the mask 30 as CPAP treatment. The mask 30 also includes an exhaust port 42 that is close to the junction of the tubing 34 with the mask 30. [0040] Adjacent to the flow generator 34 is a flow-resistive element 44. This can take the form of an iris across which a differential pressure exists. The mask side of the flow-resistive element 44 is connected by a small bore tube 46 to a pressure transducer 48 and to an input of a differential pressure transducer 50. Pressure at the other side of the flow-resistive element 44 is conveyed to the other input of the differential pressure transducer 50 by another small bore tube 52. [0041] The pressure transducer 48 generates an electrical signal in proportion to the flow pressure, which is amplified by amplifier 56 and passed both to a multiplexer/ADC unit 58 and to the motor-servo unit 40. The function of the signal provided to the motor-servo unit 40 is as a form of feedback to ensure that the static pressure is controlled to be closely approximate to the set point pressure. [0042] The differential pressure sensed across the flow-resistive element 44 is output as an electrical signal from the differential pressure transducer 50, and amplified by another amplifier 60. The output signal from the amplifier 56 therefore represents a measure of the mask or respiratory airflow rate. The controller 62 is programmed to perform a number of processing functions. [0043] The pressure and flow may be considered to be composed of steady state values and AC values, the latter reflecting the effect of a imposed oscillatory signal on the pressure having a frequency of 4 Hz. In what follows, a “steady-state” quantity is either (a) one from which the oscillatory component has been deliberately removed, for example by a filtering operation, or (b) is the result of a calculation based partly or wholly on quantities from which the oscillatory component has been removed, or (c) is a quantity which is calculated based on instantaneous quantities, such as pressure and flow measured at the flow generator (which thus include an oscillatory component), and a model of the airpath and patient leak which either partly or wholly ignores the reactive components of the system and treats it simply as a (possibly nonlinear) system of resistances. The steady state pressure loss along tubing 32 is calculated from the flow through the tube, and knowledge of the static pressure-flow characteristic of the tubing, for example by table lookup. The steady state pressure at the mask is then calculated by subtracting the tube pressure loss. The pressure loss along tube 32 is then added to the desired set pressure at the mask to yield the desired instantaneous pressure at the pressure generator 34. The flow through the exhaust 42 is calculated from the pressure at the mask from the pressure-flow characteristic of the exhaust, for example by table lookup. The steady state mask flow is calculated by subtracting the flow through the exhaust 42 from the flow through the tubing 32. The steady state patient flow is then calculated by subtracting the steady-state estimated leak, which may be determined for example in a CPAP device by a 1st order low pass filter with a time constant of 10 seconds whose input is the instantaneous mask flow, from the steady-state mask flow. [0044] The methodology put into place by the controller 62 will now be described with reference to the apparatus of FIG. 2. If the patient respiratory flow is very low or zero (note that the mask flow will not cease when the patient is apnoeic if there is any leak), a determination of airway patency (steps 14-16) is made by using an externally induced oscillation technique. If the airway is open, but the respiratory muscles are relaxed (i.e. a central apnea with open airway), then small externally originating fluctuations in the mask pressure will induce a small respiratory airflow by inflating and deflating the lungs, and by compressing and decompressing the gas in the lungs. Conversely, if the airway is closed, no airflow will be induced. This is quantified as follows: Discriminating Apneas By Admittance Thresholds [0045] The admittance Υ is given by Υ = G+iB where G is conductance and Β is susceptance. [0046] In order to decide whether the airway is open, the complex value of the patient admittance, Υ, is compared with a region of values. The value of this threshold may be selected on the basis of the following observations. [0047] An explanation for the angle being a better classifier than the magnitude is possibly related to the interaction of the complex impedances in the circuit. The leak and vent flow are essentially non-linear resistances with no complex (j) component. The patient is basically a resistance and compliance (capacitance) in series to ground. The hose drop also has a complex component in the form of the inertance of the flow. So the magnitude of the overall impedance is influenced by all components (hose, leak, vent flow, patient airway) as they all have real parts. However the imaginary component is the interaction between the inertial hose drop and the capacitive lungs. It is comparing the relative "strengths" of the inertial and capacitive reactances. [0048] It is also possible to use the real and imaginary parts of the impedance rather than the angle and magnitude. This has an advantage of reduced CPU load. The magnitude calculation requires a square root and the angle calculation involves an inverse tan. (Both of these can be done to easily the required accuracy by techniques involving lookup tables, which are computationally fairly cheap.) Using both the real and imaginary or magnitude and angle gives a more robust classification. The grouping of the open and closed values becomes much more apparent. [0049] As determined from the values in Fig. 4, a possible set of thresholds would be angle = ARG(patient admittance) if ( angle < -2 OR angle >1.2 ) AirwayState = CLOSED; else if ( angle < 0.9 AND angle > -1.5 ) AirwayState = OPEN; else AirwayState = UNKNOWN; end if where angle is in radians. The acceptable values for the thresholds may be any that permits the separation of values representing open and closed apneas determined from fig. 4. [0050] The patient resistance at 4 Hz also indicates the state of the airway. This resistance is not the reciprocal of the conductance in the above equation. The patient impedance at 4 Hz is [0051] In an alternative embodiment Rmay be used to characterize the state of the airway rather than |Y|. Calculating Admittance [0052] Patient admittance is calculated by the equation Ζ = R+iX where Υ = -. The patient resistance R is given by Y Pat - ~ ’ ^ pa t, AC r mask, AC where the numerator is the magnitude of the AC patient flow, which is in effect a measure of the differential (with respect to time) of patient flow. The denominator is the same differential of the mask pressure. Correcting for Vent Flow and Leak [0053] The patient airflow is determined by subtracting flow through the vent and leakage flow from the inflow to the mask. Qpat.AC Qniaskm. AC Qvent.AC Qe; [0054] The mean vent flow is determined either from mean mask pressure during the period of measurement, or more preferably from the square of the mean of the square root of the mask pressure during this time (which is also used to make leak calculations). The mask pressure itself is calculated in the conventional way, ignoring AC behavior of the airpath. [0055] AC vent flow is calculated using a linear approximation about the operating point: Q,vent,AC mask,AC = ρ dQVi dP Modeling Mask Pressure to Determine AC Flow at Mask [0056] The mask pressure is determined by evaluating the coefficients fq and fq, in the equation which gives the pressure drop across the vent as a function of vent flow: ^mask kQvcnl + ^Qu Thus to calculate the vent flow at a particular mask pressure, one solves the quadratic equation for vent flow at that mask pressure. [0057] ^vent can be obtained by differentiation of the previous equation, ^■^mask which gives dP dQ = k, +2PQV, [0058] Since ≈ j a small-signal approximation yields AQ ≈ AP j from which it follows as a reasonable approximation that Q vent, AC k, +2k2Qvcn, Calculating Leakage Flow [0059] To complete the calculation of the patient airflow it is necessary to also calculate the leakage flow from the inflow to the mask. The actual leak is calculated over the time period during which the patient 4 Hz admittance is calculated. Typical leak coefficient estimates relate to what happened some time ago, and one may, as in the prior art AutoSet CS and AutoVPAP devices estimate the leak coefficient Kleak from Qnonvent Aeak - where the overbars indicate the mean over the measurement period. During apnea the leak is equal to the total non-vent flow Qnonvent Qh( i'l'ola I Qvent and during breathing, the leak is (to a good approximation) equal to the average non-vent flow. In the above estimation of Kleak, all quantities are calculated without reference to the AC characteristics of the airpath, based on instantaneous values, treating the airpath as a nonlinear resistor. [0060] The model for instantaneous leak, both DC (on which the above formula for Kleak is based) and AC is Qleak K|eak VP and, as with vent flow, the AC component (at 4 Hz) of leak flow is found using the small-signal approximation Qleak,AC ^mask,ACdQ dP where we may calculate ^leak by differentiating the above equation directly, giving dP dQ,-leak ^Teak dPmask 2^/P [0061] The mean for , may be either or . The latter is preferred (because it gives an unbiased estimate of the mean value of ^leak when dP Pmsk is not constant, and we have already calculated it in order to estimate Kleak), yielding dQleak Qnonvent dPmask 2∩ΤΤ lv mask I Determination of AC values [0062] Throughout this description, the AC values referred to are determined from measurements as trigonometric Fourier components at the exciting frequency. This is an improvement over the prior art use of the forced oscillation technique, which used square waves as an orthonormal set of functions . [0063] All AC quantities are calculated as complex numbers. In particular, the AC pressure and flow at the mask are calculated by finding the sine and cosine components of instantaneous pressure and flow oven the period of measurement using the inner products with the sine and cosine function respectively, yielding component coefficients cs and cc, then writing either cs +icc or cc +ics as the AC value. (Either of these two forms is used, the two forms differing merely in a phase shift, but the one form is used consistently throughout). Alternatively other standard methods of estimating the amplitude and phase of the sinusoidal component of the pressure and flow at the exciting frequency may be used, such as least-squares fitting of a sine and a cosine. [0064] Explicitly we have _1_ Τ2πI w j" f (t)sin(cDt)dt; ο J_ Τ2πℓ w J" f (t)cos(cDt)dt; ο where the exciting frequency is Τ/2Β, Τ is a normalizing factor, and the integral may be replaced by a summation using discrete sampled values of sine and cosine. f(t) is any function whose Fourier coefficients are required. [0065] All quantities are determined over a 6 second sliding window (the “admittance window”) symbolically indicated as t=0. An admittance calculation can in principle be made at the algorithmic sampling frequency (say 50 Hz), but for clinical purposes this is not essential, and the calculation may be efficiently performed at the end of every 4 Hz cycle. Alternatively, calculation of admittance at 2 Hz or even 1 Hz frequencies is reasonable for clinical purposes. [0066] Due to motor controller delays, the first cycle (250 ms) of the pressure waveform may not be sinusoidal, and there will be some delay in setting up a steady state in the airpath, so the first 250 ms of data may be ignored. [0067] The sine and cosine values would be stored in a table generated at startup or specified as constants in the source code. Sufficient accuracy is provided if multiplications are fixed point, 16 bit * 16 bit with a 32 bit result, assuming of course that overflow of the sum does not occur, and there are no numerical stability issues with this approach. Thus the computational cost is relatively small. Modeling Impedance on a Two Port Network [0068] The calculation of AC pressure at the mask and AC flow entering the mask is in one embodiment determined from a 2-port electrical network analogue of the flow in the system at a particular frequency. [0069] From Fig.3, routine circuit analysis gives V =Υ -I Ζ out in in inout V I = I ™!_ out in ry ,z“'outgnd and of course these correspond to pressure and the mask and flow entering the mask respectively. Explicitly: Ρ = Ρ -∩ 7 A mask, AC AFG, AC Vfg,AC ^mout Q, ma skin, AC = Qi -FG,AC L mask,AC “'outgnd [0070] The impedances Zinout and Zoutgnd are taken to be functions of average flow. These impedances are measured for a particular airpath at a number of average flow levels (see below for details). The average total flow generator flow during the admittance window is determined, and for each of Zinout and Zoutgnd, is used to linearly interpolate between the measured impedances to determine the impedance at that average flow level. [0071] The inlet and outlet AC flows and AC pressures are determined over a period of 30 seconds (to reduce noise) using the standard inner product method described above for the calculation of Fourier coefficients, yielding complex values. These values are used to calculate the 2-port parameters (refer to figure 1, where voltages and currents in that figure correspond to pressures and flows respectively in the following), by: Ζ Q„ “'outgnd Qn-Q* If the denominators are very small or zero, the impedances are taken to have some numerically very large value in relation to typical airpath impedances. The Hose Pressure Drop Theoretical Model [0072] The hose drop is the pressure difference between the internal mask pressure and the FG pressure. It is the pressure loss across all components that are placed before the mask. This includes mufflers, humidifiers, ΑΒ filters and the mask connection hose. [0073] The complete hose drop is made up of the resistive hose drop as well as the inertial pressure drop P„„.«,„p= K,Qi, +K,Q„ + Kl^ Kj , K2 = empirically derived constants KL = theoretically determined flow inertance constant Qfg =FGF1ow ρ = air density (1.19 kg/m3) 1 = tube length (2 or 3m) πά 2 Α= cross sectional area ( ,d = 0.019m) 4 [0074] In the case of masks such as the ResMed Activa and Swift masks there is another tube between the main hose and the mask. This must also be taken into account in the inertial constant. [0075] The mean hose drop is made up of purely the resistive part (the over bar indicates mean): Phosedrop ^ Q FG + K2 Q pG Kj, K2 = empirically derived constants Qfg =MeanFGFlow [0076] In order to calculate the AC hose drop some linearization is necessary. The resistive and inertial components are separated. The resistive component is derived by linearizing the above mean hose drop formula about the operating point. dP -^ps = 2K,QFO + K2 dQFG Phosedropresisitive,AC - V^^iQfG + /QfG, AC [0077] The AC hose drop is thus the AC flow multiplied by gradient of the hose non-linear resistance at the location around which the small oscillation occurs. For the derivation it is assumed that the oscillations are of a small magnitude compared to the change in the gradient of the hose resistance. [0078] The inertial component is a constant multiplied by the time derivative of the FG flow. By standard linear circuit theory, an inductance L has impedance sL, which for sinusoidal signals at the frequency ω is jmL.The inertial hose drop component then becomes: Phosedropinertance, AC ^ |. j |(j. AT ω = 2 irf Combining the two gives ^drop, AC - (2K,QKi + Κ2 + KLj«)QFG, A( Mask Pressure [0079] The mask pressure is the FG pressure minus the hose pressure drop: ρ = ρ - ρ mask FG hosedrop Ρ =Ρ -Ρ mask,AC aFG,AC Ahosedrop,AC Examples [0080] In Fig. 4 a plot is presented in which the thick lines represent open apneas and the thin lines represent closed apneas. The horizontal axis represents the absolute magnitude of the admittance, while the vertical axis represents the phase of the complex admittance. As may be seen from the figure, there is a complete separation of the open apneas, represented by the thick curves in the center of the graph, from the closed apneas, represented by the two thinner curve regions, one near the origin and the other at the extreme upper value of the y axis. If one looks only at the absolute value of the admittance, in effect by projecting all of the data onto the χ axis, the separation of the data is lost, with the projection of the thin (closed apnea) curves meeting the projection of the thick (open apnea) data. [0081] Figure 4 shows the result of plotting patient admittance data calculated according to the formulas above. The χ axis values are the average absolute value of the patient admittance. The y axis values are the phase angle of the patient admittance. As may be seen from Fig. 4 there is a clean separation of the values for closed apneas and for open apneas. [0082] Figure 5 shows the result of plotting patient admittance where instead of the previous calculation of admittance a value for the complex admittance is determined from a model that is essentially independent of the modelling details of any particular configuration of mask or ventilation circuit. In particular, the data for Fig. 5 were determined by using a simple leak orifice model Ρ = (KQ)2. It may be seen from Fig. 5 that the open and closed apneas result in separated regions of the plot of the complex admittance. Moderate (Approximated patient admittance) Algorithm [0083] The third algorithm attempts to approximate the patient admittance by generically modeling the patient circuit and combining the leak and vent flows. [0084] The patient circuit is modeled in the same way as the Complex algorithm above, however the constants are fixed at those for a 2m hose with ΑΒ filter. [0085] The leak and vent flow modeling are combined into one parameter which is the non patient flow. This is modeled as Leak + Vent flow [0086] The leak and vent flow are combined and modeled as using the following equations: [0087] The leak orifice can be approximated at runtime using: K-leak - Qfg [0088] The instantaneous leak is then calculated using Qleak K|cak yfP, [0089] Using small signal approximation we can say that Q-leak,i^2 x mask,AC = ρ dQ, dP, where dQ, dP„, 'mask A mask Κ, (from instantaneous leak equation) substituting in K|eak we get Qleak.AC Pi Q FG leak,.^ mask,AC ^(v/Pmask j can approximate (yCr)2 wi as we are dealing with small mean Pmask changes we with Pmsk so the AC leak becomes Qleak.AC Pmask, AC Qj FG 2Ρ Approximated Patient Flow [0090] The patient flow is then Qpatient, AC QfG.AC Qleak.AC [0091] Qleak is the leak flow combined with the vent flow (all non patient flow). Classification [0092] There are a number of ways to use the approximated admittance to classify the airway state. Good separation in just the angle can be seen when plotting the angle vs magnitude of the admittance. Therefore a simple classification would be to have two thresholds, but purely on angle. However the calculation of the angle involves a division and an inverse tan, requiring more calculation. It is suggested that it is preferable to have the real and imaginary parts of the admittance used instead. Thresholds [0093] The simplest thresholds which provide good classification accuracy are simple straight diagonal lines. These are of the form y > χ + b and y < χ + c. In this case when plotting the imaginary part (y) vs the real part (χ) of the admittance, CLOSED is y > χ + b, and OPEN is y < χ + c. Based on the floating-point algorithm the values for the constants were b=0, ℮=-0.03. This gave no misclassification. Any other curves that separate the data regions could be used, but the linear separation reduces the complication of the threshold calculations and is for that reason preferred. Alternative Embodiment [0094] In an alternative embodiment, incorporated by reference from US Provisional Application 60/916,147, the patient impedance is first measured during normal breathing, for example at the end of the expiratory portion of the breath. This measured impedance is averaged over a predetermined time period. The average normal impedance value is compared to the measured impedance during a detected apnea. The determination of an open or closed airway based on impedance is then performed. [0095] This alternative method has the advantages of taking into account the entire patient circuit including the patient's airway and makes unnecessary the requirement for the patient circuit components to be characterized. In addition this system automatically takes into account the current altitude and ambient conditions. [0096] The system allows for plausibility data to be generated using fuzzy logic. For example if a strange impedance measurement is obtained when the patient is breathing normally then the algorithm can detect this and deliver an implausible result. Also wildly varying impedance values may indicate a fault in the system. The system may also detect if inappropriate components are present in the system and deliver an error. 1. An apparatus for providing a supply of continuous positive airway pressure to an airway of a patient at a desired treatment pressure, the apparatus comprising:a flow generator adapted to provide a supply of continuous positive airway pressure, the flow generator adapted to couple with an air delivery tube coupled with a patient interface configured to sealingly engaged with a face of the patient;a means for determining respiratory air flow and pressure in the patient interface;a means for measuring a patient impedance of the airway during a period of a breathing cycle when an apnea is not occurring; anda controller to control operation of the flow generator based on the determined respiratory air flow and pressure,the controller configured in use to detect the occurrence of an apnea and to determine patency of the patient’s airway during the apnea by performing:controlling application of an oscillatory pressure waveform of known frequency to the patient interface for delivery to the patient’s airway in use;measuring an apnea impedance of the airway during the apnea; and comparing the measured apnea impedance with the patient impedance to determine whether the airway is patent. 2. The apparatus according to claim 1, wherein the means for determining respiratory air flow and pressure includes measuring the air flow and pressure using at least one sensor. 3. The apparatus according to claim 2, wherein the at least one sensor is a differential pressure sensor. 4. The apparatus according to any one of claims 2-3, wherein the patient impedance is determined by the controller controlling application of an oscillatory pressure waveform of known frequency to the patient interface for delivery to the patient’s airway during the period of the breathing cycle when an apnea is not occurring. 5. The apparatus according to any one of claims 1 -4, wherein the period of the breathing cycle is at an end of an expiratory portion of a breath. 6. The apparatus according to any one of claims 1 -5, wherein the patient impedance is a determined average of measured patient impedance over a predetermined time period. 7. The apparatus according to any one of claims 1 -6, wherein the controller is configured to perform a plausibility check on the measured patient impedance. 8. The apparatus according to claim 7, wherein if the measured patient impedance value is determined to be implausible, the controller indicates that a fault has occurred. 9. The apparatus according to any one of claims 1 -8, wherein the known frequency is between 1 and 16 Hz. 10. The apparatus according to claim 9, wherein the known frequency is between 2 and 8 Hz. 11. The apparatus according to claim 9, wherein the known frequency is 4 Hz. 12. The apparatus according to any one of claims 1-11, wherein the controller is further configured to increase the treatment pressure in response to the determination of a patent airway. 13. The apparatus according to any one of claims 1 -12, wherein the controller is further configured to reduce the treatment pressure in response to the determination of a closed airway. 14. A method for operating a respiratory device with a flow generator to determine patency of an airway of a patient, the method comprising:controlling generation of a first oscillatory pressure waveform of known frequency to a patient interface during a period of a breathing cycle when an apnea is not occurring;measuring respiratory air flow and pressure at the flow generator;determining a patient impedance of the airway;determining that an apnea is occurring based on the measured respiratory air controlling generation of a second oscillatory pressure waveform of known frequency to the patient interface during the apnea;determining an apnea impedance of the airway during the apnea; and determining that the airway is patent by comparing the apnea impedance with the patient impedance. 15. The method according to claim 14, wherein the period of the breathing cycle is at the end of an expiratory portion of the breath. 16. The method according to any one of claims 14-15, wherein the patient impedance is determined as an average of measured patient impedance over a predetermined time period. 17. The method according to any one of claims 14-16, further including controlling with the respiratory device a continuous positive air pressure in the patient interface at a desired treatment pressure. 18. The method according to claim 17, wherein if the apnea is classified as an open apnea determining a reduction of the treatment pressure. 19. The method according to claim 17, wherein if the apnea is classified as a closed apnea determining an increase of the treatment pressure.